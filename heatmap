import yfinance as yf
import pandas as pd
import plotly.graph_objects as go

# Define stocks from different sectors
sectors = {
    "Tech": ["TCS.NS", "INFY.NS", "WIPRO.NS"],
    "Banking": ["HDFCBANK.NS", "ICICIBANK.NS", "SBIN.NS"],
    "Auto": ["MARUTI.NS", "TATAMOTORS.NS", "M&M.NS"],
    "Pharma": ["SUNPHARMA.NS", "CIPLA.NS", "DRREDDY.NS"],
    "FMCG": ["HINDUNILVR.NS", "ITC.NS", "NESTLEIND.NS"]
}

# Flatten stock list
stocks = [stock for sector in sectors.values() for stock in sector]

# Download historical stock data (Closing Prices)
data = yf.download(stocks, start="2023-01-01", end="2024-01-01")['Close']

# Compute sector-wise average returns
sector_returns = pd.DataFrame()
for sector, stock_list in sectors.items():
    sector_returns[sector] = data[stock_list].pct_change().mean(axis=1)

# Compute correlation matrix
correlation_matrix = sector_returns.corr()

# ✅ Convert correlation values to string format (3 decimal places)
correlation_text = correlation_matrix.round(3).astype(str)

# Create Heatmap using Plotly (✅ Fixed Text Formatting)
fig = go.Figure(data=go.Heatmap(
    z=correlation_matrix.values,
    x=correlation_matrix.columns,
    y=correlation_matrix.index,
    colorscale="RdBu",
    colorbar=dict(title="Correlation"),
    text=correlation_text.values,  # ✅ Convert DataFrame to a List
    texttemplate="%{text}"  # ✅ Ensure proper formatting
))

fig.update_layout(
    title="Sector Correlation Heatmap",
    xaxis_title="Sector",
    yaxis_title="Sector",
    width=600, height=500
)

fig.show()
